{{- $kubefullname := include "kubernetes.fullname" . }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kubernetes.fullname" . }}
data:
  config: |-
    http_address = "0.0.0.0:{{ .Values.oauthConfig.port }}"
    redirect_url = {{ .Values.oauthConfig.redirectUrl | quote }}
    provider= "oidc"
    oidc_issuer_url= {{ .Values.oauthConfig.oidcIssuerUrl | quote }}
    client_id = {{ .Values.oauthConfig.clientId | quote }}
    client_secret = {{ .Values.oauthConfig.clientSecret | quote }}
    cookie_name= {{ .Values.oauthConfig.cookieName | quote }}
    cookie_secret = {{ .Values.oauthConfig.cookieSecret | quote }}
    email_domains = {{ .Values.oauthConfig.emailDomains | quote }}
  default.conf: |-
    server {
      listen {{ .Values.portal.port }};
      server_name {{ .Values.hostName }};
      root /usr/share/nginx/html;
      index index.html;

      location / {
        try_files $uri /index.html;
      }

      {{- range .Values.links }}
      location /services/{{ .path }} {
        rewrite ^/services/test$ {{ .url }} permanent;
      }
      {{- end }}
    }

  index.html: |-
    <!doctype html>

    <html lang="en">
    <head>
      <meta charset="utf-8">
      <title> {{ .Values.portal.title }} </title>
    </head>

    <body>
      <div>
        <ul>
          {{- range .Values.links }}
          <li><a href="http://{{- $.Values.hostName -}}/services/{{- .path -}}"> {{ .name }} </a></li>
          {{- end }}
        </ul>
      </div>
    </body>
    </html>
